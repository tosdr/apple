"use strict";var __awaiter=this&&this.o||function(o,e,n,t){return new(n||(n=Promise))((function(r,i){function d(o){try{u(t.next(o))}catch(o){i(o)}}function c(o){try{u(t.throw(o))}catch(o){i(o)}}function u(o){var e;o.done?r(o.value):(e=o.value,e instanceof n?e:new n((function(o){o(e)}))).then(d,c)}u((t=t.apply(o,e||[])).next())}))},curatorMode=!1,apiUrl="api.tosdr.org";function handleUrlInURLIfExists(o){return __awaiter(this,void 0,void 0,(function*(){var e=o.split("?url=")[1];if(!e)return document.getElementById("id").innerHTML="Error: no service-id in url",document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",document.getElementById("nourl").style.display="block",void(document.getElementById("pointList").style.display="none");var n=yield searchToSDR(e);if(n){document.getElementById("phoenixButton").onclick=function(){window.open(`https://edit.tosdr.org/services/${n}`)},themeHeaderIfEnabled(n);document.getElementById("logo").src=`https://s3.tosdr.org/logos/${n}.png`,document.getElementById("id").innerText=n,getServiceDetails(n,!0)}else document.getElementById("id").innerText="Error: no service-id in url",document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",document.getElementById("nourl").style.display="block",document.getElementById("pointList").style.display="none"}))}function getServiceIDFromURL(o){var e=o.split("?service-id=")[1];if(!e)return void handleUrlInURLIfExists(o);if("-1"===(e=e.replace("#","")))return document.getElementById("id").innerHTML="Error: no service-id in url",document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",document.getElementById("nourl").style.display="block",document.getElementById("notreviewed").style.display="block",document.getElementById("pointList").style.display="none",void(document.getElementById("edittext").onclick=function(){window.open("https://edit.tosdr.org")});document.getElementById("phoenixButton").onclick=function(){window.open(`https://edit.tosdr.org/services/${e}`)},themeHeaderIfEnabled(e);document.getElementById("logo").src=`https://s3.tosdr.org/logos/${e}.png`,document.getElementById("id").innerHTML=e,getServiceDetails(e)}function themeHeaderIfEnabled(o){chrome.storage.local.get(["themeHeader"],(function(e){if(e.themeHeader){const e=`.header::before {\n                content: '';\n                position: absolute;\n                background-image: url('https://s3.tosdr.org/logos/${o}.png');\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 90%;\n                background-repeat: no-repeat;\n                background-position: center;\n                background-size: cover;\n                filter: blur(30px);\n                z-index: -2;\n            }`;var n=document.createElement("style");document.head.appendChild(n),n.sheet.insertRule(e)}}))}function themeHeaderColorIfEnabled(o){chrome.storage.local.get(["themeHeaderRating"],(function(e){if(e.themeHeaderRating){document.getElementById("headerPopup").classList.add(o)}}))}function getServiceDetails(o,e=!1){return __awaiter(this,void 0,void 0,(function*(){const n=`https://${apiUrl}/service/v2/?id=${o}`,t=yield fetch(n);if(t.status>=300)return document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",void(document.getElementById("error").style.display="flex");const r=yield t.json();if(256!==r.error)return document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",void(document.getElementById("error").style.display="flex");const i=r.parameters.name,d=r.parameters.rating,c=r.parameters.points,u=document.getElementsByClassName("serviceName");for(let o=0;o<u.length;o++)u[o].innerText=i;document.getElementById("title").innerText=i,d?(document.getElementById("gradelabel").classList.add(d.toLowerCase()),themeHeaderColorIfEnabled(d.toLowerCase()),document.getElementById("grade").innerText=d):document.getElementById("grade").innerText="N/A",document.getElementById("pointsCount").innerText=c.length,document.getElementById("loading").style.opacity="0",document.getElementById("loaded").style.filter="none",setTimeout((function(){document.getElementById("loading").style.display="none"}),200),e&&(document.getElementById("notreviewedShown").style.display="block"),populateList(c)}))}function populateList(o){const e=document.getElementById("pointList"),n=(o=curatorMode?o.filter((o=>"approved"===o.status||"pending"===o.status)):o.filter((o=>"approved"===o.status))).filter((o=>"blocker"===o.case.classification)),t=o.filter((o=>"bad"===o.case.classification)),r=o.filter((o=>"good"===o.case.classification)),i=o.filter((o=>"neutral"===o.case.classification));createPointList(n,e,!1),createPointList(t,e,!1),createPointList(r,e,!1),createPointList(i,e,!0)}function curatorTag(o){return curatorMode&&"approved"!==o?"<img src='icons/pending.svg'></img>":""}function createPointList(o,e,n){var t=0;for(let n=0;n<o.length;n++){const i=document.createElement("div");var r=`\n        <div class="point ${o[n].case.classification}">\n            <img src="icons/${o[n].case.classification}.svg">\n            <p>${o[n].title}</p>\n            ${curatorTag(o[n].status)}\n        </div>`;if(i.innerHTML=r.trim(),e.appendChild(i.firstChild),t++,n!==o.length-1){const o=document.createElement("hr");e.appendChild(o)}}if(0!==t&&!n){const o=document.createElement("hr");o.classList.add("group"),e.appendChild(o)}}function searchToSDR(o){return __awaiter(this,void 0,void 0,(function*(){const e=`https://${apiUrl}/search/v4/?query=${o}`,n=yield fetch(e);if(200!==n.status)return document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",void(document.getElementById("error").style.display="flex");const t=yield n.json();if(256!==t.error)return document.getElementById("loading").style.display="none",document.getElementById("loaded").style.display="none",void(document.getElementById("error").style.display="flex");if(0!==t.parameters.services.length){const e=t.parameters.service[0].urls;for(let n=0;n<e.length;n++)if(e[n]===o)return t.parameters.services[0].id}}))}function ifFirefoxDesktopResize(){navigator.userAgent.includes("Firefox")&&!navigator.userAgent.includes("Mobile")&&(document.body.style.width="350px")}getServiceIDFromURL(window.location.href),chrome.storage.local.get(["darkmode","curatorMode","api"],(function(o){if(o.darkmode){document.querySelector("body").classList.toggle("dark-mode")}o.curatorMode?(document.getElementById("curator").style.display="block",curatorMode=!0):document.getElementById("curator").style.display="none",o.api&&0!==o.api.length&&(apiUrl=o.api)})),document.getElementById("toggleButton").onclick=function(){const o=document.querySelector("body");o.classList.toggle("dark-mode");const e=o.classList.contains("dark-mode");chrome.storage.local.set({darkmode:e})},document.getElementById("settingsButton").onclick=function(){chrome.runtime.openOptionsPage()},document.getElementById("sourceButton").onclick=function(){window.open("https://github.com/tosdr/browser-extensions")},document.getElementById("source").onclick=function(){window.open("https://github.com/tosdr")},document.getElementById("opentosdr").onclick=function(){window.open("https://tosdr.org/")},ifFirefoxDesktopResize();